name: Build

on: 
  push:
    branches:
      - '*'
  workflow_dispatch:
      
jobs:
  common:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Common
        run: |
          cd common
          pip install build twine
          python -m build
          twine upload --username __token__ --password "${{ secrets.PYPI_TOKEN }}"

  video-streaming:
    needs: 
      - common
    uses: ./.github/workflows/build-template.yaml
    with:
      DIRECTORY: video-streaming 
  metadata:
    needs: 
      - common
    uses: ./.github/workflows/build-template.yaml
    with:
      DIRECTORY: metadata 
  history:
    needs: 
      - common  
    uses: ./.github/workflows/build-template.yaml
    with:
      DIRECTORY: history    
  azure-storage:
    needs: 
      - common  
    uses: ./.github/workflows/build-template.yaml
    with:
      DIRECTORY: azure-storage
  gateway:
    needs: 
      - common  
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3    
      - name: gateway build and test
        run: |    
          cd gateway
          npm install
  integration-tests:
    runs-on: ubuntu-latest
    needs:
      - video-streaming
      - metadata
      - history
      - azure-storage
      - gateway
    env:
      STORAGE_ACCESS_KEY: ${{ secrets.STORAGE_ACCESS_KEY }}
    steps:
      - uses: actions/checkout@v2
      - name: Build the stack
        run: |
          cp tests/integration/test.env ./.env
          echo -e "\nSTORAGE_ACCESS_KEY=${{ secrets.STORAGE_ACCESS_KEY }}" >> .env
          cat .env
          docker-compose -f docker-compose-prod.yml up --build -d
          sleep 10
      - name: Run the tests   
        uses: nick-fields/retry@v2
        with:
          max_attempts: 3
          retry_on: error
          timeout_seconds: 120
          command: |
            env
            cd tests/integration
            pip install -r requirements.txt
            pytest -s           
